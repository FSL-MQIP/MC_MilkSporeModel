---
title: "Milk Spore Model"
author: "Luke Qian, Tim Lott, Sarah I. Murphy"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 60), tidy = TRUE)
```

## 1. Set-up environment
* load packages
* load functions
* set seed for reproducibilty
```{r, message=FALSE, warning=FALSE}
## load packages
library(readr)
library(censReg)
library(fitdistrplus)
library(splitstackshape)
library(rmutil)
library(truncnorm)
library(EnvStats)
library(epiR)
library(stats)
library(reshape2)
library(caret)
library(vip)
library(numbers)
library(tidyverse)

## load functions
source("UtilityFunctions.R")
```

## 2. Load input files
* load
```{r}
## AT frequency data (from Ariel_2017MC_SporeModel on MC-2020 on GitHub)
ATfreq = read.csv("InputFiles/Baseline_ATFreq.csv", stringsAsFactors = FALSE, header = TRUE)

## growth parameter data; make sure this contains growth parameters & growth model name
GrowthParas = read.csv("InputFiles/GrowthParameters_NoGrowthATs.csv" , stringsAsFactors = FALSE)

## initial microbial count data (from Ariel_2017MC_SporeModel on MC-2020 on GitHub)
InitConcData = read.csv("InputFiles/Baseline_InitialSporeCount.csv")
```

## 3. Process model parameters
```{r, warning=FALSE}
## Extract AT frequency 
ATfreq = ATfreq %>% pull(ClosestAT)

GrowthParas = GrowthParas %>%
  select(rpoBAT, lag, mumax, LOG10Nmax)

## Fit initial spore concentration into a normal distribution
DistFit = InitConcData %>% 
  mutate(log10left = log10(left),
         log10right = log10(right)) %>% 
  select(log10left, log10right) %>% 
  rename(left = log10left, right = log10right) %>% 
  fitdistcens(., distr = "norm")

Log10InitConc_mean = DistFit$estimate[1]
Log10InitConc_sd = DistFit$estimate[2]
```


## 4. ESL milk model (facility -> storage at home)
5 stages:
i. Storage in facility
ii. Transportation to retail store (starts at end of storage at facility, includes all tranport/storage events up to arrival at retail store, ends at arrival at retail store)
- assumes that 1 retail store
iii. Storage/display at retail store 
iv. Transportation from retail store to home
v. Storage at home

### set-up dataframe for modeling half-gallons (Hgal) milk:
*lot_id (1:100) aka n_sim
*unit_id (1:10) 

*initial count is unique by lot, unit
*AT is unique by lot, unit

*t_F: duration of storage at the facility by lot (in days)
*T_F: temperature during storage at the facility by lot, same for all units within same lot (in Celsius)

*t_T: duration of transportation from facility to the retail store by lot (in days)
*T_T: temperature during stransportation from facility to the retail store by lot (in Celsius)

*t_S: duration of storage/display at the retail store by lot (in days)
*T_S: temperature during storage/display at the retail store by lot (in Celsius)

*t_T2: duration of transportation from retail store to homes by lot (in days)
*T_T2: temperature during transportation from retail store to homes by lot (in Celsius)

*t_H: duration of storage at homes by lot (in days)
*T_H: temperature during store at homes by lot (in Celsius)


```{r}
set.seed(123)
## Set the number of lots and containers ###################################################################
n_sim = 100
n_units = 10

lot_id = rep(seq(1, n_sim), each = n_units)
unit_id = rep(seq(1,n_units), times = n_sim) 
ModelData = tibble(lot_id, unit_id)

## Set the initial spore concentration #####################################################################
## get initial count
spore_log10MPN_samp  = rnorm(n_sim, Log10InitConc_mean, Log10InitConc_sd) 
## Convert log10 MPN/mL to MPN/mL
spore_MPN_samp <- 10^spore_log10MPN_samp
## Convert MPN for each 1900 mL milk container
spore_MPN_samp_halfgal <- spore_MPN_samp * 1900
#Sample the MPN_init distribution
spore_MPN_init<-vector()
for (i in 1:n_sim){
  spore_MPN_init_samp <-rep(rpois(n_units, spore_MPN_samp_halfgal[i]))
  spore_MPN_init<-c(spore_MPN_init, spore_MPN_init_samp)}
# First convert spore_MPN_init from half-gallon to mLs
spore_MPN_init[spore_MPN_init < 1] = 0
spore_MPN_init_mL = spore_MPN_init / 1900
# Remove 0's from the data and replace with detection limit
spore_MPN_init_mL[spore_MPN_init_mL <= 0 ] = 0.01


ModelData$log10InitConc = log10(spore_MPN_init_mL)

#What-if scenario 1: Microfiltration
#2.2 log reduction of psychrotolerant spores
#ModelData$log10InitConc = ModelData$log10InitConc - 2.2

#What-if scenario 2: Bactofugation I
#1.4 log reduction of spores
#ModelData$log10InitConc = ModelData$log10InitConc - 1.4

#What-if scenario 3: Bactofugation II
#2 log reduction of spores 
#ModelData$log10InitConc = ModelData$log10InitConc - 2


## Assign AT and Nmaxto each milk container ########################################################################
growthAT = vector()
for (i in 1:(n_units * n_sim)){
    AT_samp = sample(ATfreq, 1,replace = T)
    while(AT_samp == "AT_23" || AT_samp == "AT_159"){
      AT_samp = sample(ATfreq, 1,replace = T)}
    growthAT[i] = AT_samp
  }

ModelData$AT = growthAT
ModelData$AT_index = match(ModelData$AT, GrowthParas$rpoBAT)
ModelData$log10Nmax = GrowthParas$LOG10Nmax[ModelData$AT_index]

## Simulate temperature and time for each supply chain stage ###############################################
#stage1, storage at facility
ModelData$T_F = rep(runif(n_sim, min = 3.5, max = 4.5), each = n_units) # temp
ModelData$t_F = rep(runif(n_sim, min = 1, max = 2), each = n_units)     # time

#stage2, transport to retail store
ModelData$T_T = rep(rtri(n_sim, min = 1.7, max = 10.0, mode = 4.4), each = n_units) # temp
ModelData$t_T = rep(rtri(n_sim, min = 1, max = 10, mode = 5), each = n_units)       # time

#stage3, storage/display at retail store
ModelData$T_S = rep(rtruncnorm(n_sim, a = -1.4, b = 5.4, mean = 2.3, sd = 1.8), each = n_units)       # temp
ModelData$t_S = rep(rtruncnorm(n_sim, a = 0.042, b = 10.0, mean = 1.821, sd = 3.3), each = n_units)   # time

#stage4, transport from retail store to homes
ModelData$T_T2 = rep(rtruncnorm(n_sim, a = 0, b = 10, mean = 8.5, sd = 1.0), each = n_units)          # temp
ModelData$t_T2 = rep(rtruncnorm(n_sim, a = 0.01, b = 0.24, mean = 0.04, sd = 0.02), each = n_units)   # time

#stage5, storage at homes
temps = vector()
for (i in 1:(n_sim*n_units)){
  number <- rlaplace(1,m=4.06,s=2.31)
  while (number > 15 | number < -1) {
    number <- rlaplace(1,m=4.06,s=2.31) #make sure that this cannot be >15 or < -1
  }
  temps[i] <- number
}

ModelData$T_H = temps 


#What-if scenario 4: Manually reduce mean temp at facility 
#ModelData$T_F = rep(runif(n_sim, min = 2.5, max = 3.5), each = n_units) 

#What-if scenario 5: Extreme cooling
#ModelData$T_F = rep(runif(n_sim, min = 0.5, max = 1.5), each = n_units)

#What-if scenario 6: Improved cooling system at facility
#ModelData$T_F = rep(runif(n_sim, min = 3.75, max = 4.25), each = n_units) 

#What-if scenario 7: Temp alarm system in truck
#ModelData$T_T = rep(rtri(n_sim, min = 1.7, max = 6.0, mode = 4.4), each = n_units)

#What-if scenario 8: Optimize distribution routes
#ModelData$t_T = rep(rtri(n_sim, min = 1, max = 7, mode = 5), each = n_units)

#What-if scenario 9: Manually reduce mean temp at retail store
#ModelData$T_S = rep(rtruncnorm(n_sim, a = -1.4, b = 5.4, mean = 1.8, sd = 1.8), each = n_units)

#What-if scenario 10: Temp alarm system at retail store
#ModelData$T_S = rep(rtruncnorm(n_sim, a = -1.4, b = 4, mean = 2.3, sd = 1.8), each = n_units)

#What-if scenario 11: Improved cooling system at retail store
#ModelData$T_S = rep(rtruncnorm(n_sim, a = -1.4, b = 5.4, mean = 2.3, sd = 0.9), each = n_units) 

```


### set up lag time and mumax at each supply chain stage


```{r}
# stage1, storage at facility
ModelData$newLag_F = lagAtNewTemp(ModelData$T_F, GrowthParas$lag[ModelData$AT_index])
ModelData$newMu_F =  muAtNewTemp(ModelData$T_F, GrowthParas$mumax[ModelData$AT_index])

# stage2, transport to retail store
ModelData$newLag_T = lagAtNewTemp(ModelData$T_T, GrowthParas$lag[ModelData$AT_index])
ModelData$newMu_T =  muAtNewTemp(ModelData$T_T, GrowthParas$mumax[ModelData$AT_index])

# stage3, storage/display at retail store
ModelData$newLag_S = lagAtNewTemp(ModelData$T_S, GrowthParas$lag[ModelData$AT_index])
ModelData$newMu_S =  muAtNewTemp(ModelData$T_S, GrowthParas$mumax[ModelData$AT_index])

# stage4, transport from retail store to homes
ModelData$newLag_T2 = lagAtNewTemp(ModelData$T_T2, GrowthParas$lag[ModelData$AT_index])
ModelData$newMu_T2 =  muAtNewTemp(ModelData$T_T2, GrowthParas$mumax[ModelData$AT_index])

# stage5, storage at homes
ModelData$newLag_H = lagAtNewTemp(ModelData$T_H, GrowthParas$lag[ModelData$AT_index])
ModelData$newMu_H =  muAtNewTemp(ModelData$T_H, GrowthParas$mumax[ModelData$AT_index])
```


### Model bacterial growth
```{r}
# stage1, storage at facility
ModelData = ModelData %>%
  rowwise() %>% 
  mutate(predConc_F = log10N_func(t = t_F, lag = newLag_F, mumax = newMu_F,
                                  LOG10N0 = log10InitConc, LOG10Nmax = log10Nmax))

# stage2, transport to retail store
ModelData = ModelData %>% 
  rowwise() %>% 
  mutate(Lag_T = max(0, 1 - t_F/newLag_F) * newLag_T) %>%  
  mutate(Mu_T = if_else(T_T >= T_F * 0.75 & T_T <= T_F * 1.25, newMu_F, newMu_T)) %>% 
  mutate(predConc_T = log10N_func(t = t_T, lag = Lag_T, mumax = Mu_T,
                                  LOG10N0 = predConc_F, LOG10Nmax = log10Nmax))

# stage3, storage/display at retail store
ModelData = ModelData %>% 
  rowwise() %>% 
  mutate(Lag_S = max(0, 1 - t_T/Lag_T) * newLag_S) %>%  
  mutate(Mu_S = if_else(T_S >= T_T * 0.75 & T_S <= T_T * 1.25, newMu_T, newMu_S)) %>% 
  mutate(predConc_S = log10N_func(t = t_S, lag = Lag_S, mumax = Mu_S,
                                  LOG10N0 = predConc_T, LOG10Nmax = log10Nmax))

# stage4, transport from retail store to homes
ModelData = ModelData %>% 
  rowwise() %>% 
  mutate(Lag_T2 = max(0, 1 - t_S/Lag_S) * newLag_T2) %>%  
  mutate(Mu_T2 = if_else(T_T2 >= T_S * 0.75 & T_T2 <= T_S * 1.25, newMu_S, newMu_T2)) %>% 
  mutate(predConc_T2 = log10N_func(t = t_T2, lag = Lag_T2, mumax = Mu_T2,
                                   LOG10N0 = predConc_S, LOG10Nmax = log10Nmax))

# stage5, storage at homes
ModelData = ModelData %>% 
  slice(rep(1:n(), each = 35)) 

ModelData$t_H = rep(1:35, times = n_sim * n_units)

ModelData = ModelData %>% 
  rowwise() %>% 
  mutate(Lag_H = max(0, 1 - t_T2/Lag_T2) * newLag_H) %>%  
  mutate(Mu_H = if_else(T_H >= T_T2 * 0.75 & T_H <= T_T2 * 1.25, newMu_T2, newMu_H)) %>% 
  mutate(predConc_H = log10N_func(t = t_H, lag = Lag_H, mumax = Mu_H,
                                  LOG10N0 = predConc_T2, LOG10Nmax = log10Nmax))

# Assign the spoilage to each milk container at each day
ModelData = ModelData %>% 
  rowwise() %>% 
  mutate(spoil = predConc_H > log10(20000))
```



## 5. Validation

# Validation 1
* Use Ariel's validation dataset to check if new modification can be validated.
```{r, eval=FALSE}
# Initial validation
# Use validation dataset from previous model (Buehler et al., 2018) to validate the modification.
Val1Data = tibble(SampleID = 1:1000)

Val1Data$AT = sample(growthAT, 1000, replace = T)
Val1Data$AT_index = match(Val1Data$AT, GrowthParas$rpoBAT)
Val1Data$log10Nmax = GrowthParas$LOG10Nmax[Val1Data$AT_index]
Val1Data$mumax = GrowthParas$mumax[Val1Data$AT_index]
Val1Data$lag = GrowthParas$lag[Val1Data$AT_index]
Val1Data$DayInit = rnorm(1000, mean = Log10InitConc_mean, sd = Log10InitConc_sd)

Val1Data = Val1Data %>% 
  mutate(predDay14 = log10N_func(t = 14, lag = lag, mumax = mumax, 
                                 LOG10N0 = DayInit, LOG10Nmax = log10Nmax),
         predDay21 = log10N_func(t = 21, lag = lag, mumax = mumax, 
                                 LOG10N0 = DayInit, LOG10Nmax = log10Nmax))
  


pred_counts_14 = Val1Data %>% filter(predDay14 > 1) %>% pull(predDay14)
pred_counts_21 = Val1Data %>% filter(predDay21 > 1) %>% pull(predDay21)

# load validation dataset
VSL_import_14 <- read.csv("InputFiles/ValidationData1_d14.csv")
VSL_import_21 <- read.csv("InputFiles/ValidationData1_d21.csv")
VSL_counts_14 <- VSL_import_14$log_VSL_D14
VSL_counts_21 <- VSL_import_21$log_VSL
ks.test(pred_counts_14, VSL_counts_14)
ks.test(pred_counts_21, VSL_counts_21)

#summary(pred_counts)
#sd(pred_counts)
#summary(VSL_counts)
#sd(VSL_counts)

pred_14 = cbind(rep("Simulated", length(pred_counts_14)),pred_counts_14)
pred_14 = as.data.frame(pred_14)
names(pred_14) = c("Type","counts")
VSL_14 = cbind(rep("Actual", length(VSL_counts_14)), VSL_counts_14)
VSL_14 = as.data.frame(VSL_14)
names(VSL_14) = c("Type","counts")
val_data_14 = rbind(pred_14,VSL_14)
val_data_14$counts = as.numeric(val_data_14$counts)

ggplot(data = val_data_14, aes(x=Type,y=counts))+
  geom_boxplot()+
  coord_flip()+
  theme_bw()+
  theme(axis.title.y = element_blank())
ggsave("Figures/Fig2.Val1_boxplot.tiff", height = 2, width = 8, units = "in", dpi = "retina")

ggplot(data = val_data_14, aes(x=counts))+
  stat_ecdf(aes(linetype=Type))+
  theme_bw()+
  theme(legend.position = c(0.8, 0.2))+
  labs(x=expression(paste(LOG[10],CFU/mL)), y= "Density")
ggsave("Figures/Fig2.Val1_cumulative density.tiff", height = 4, width = 8, units = "in", dpi = "retina")

```


# Validation 2 and 3
```{r, eval=FALSE}
source("Validation/Validations.R", print.eval = T)
```



## 6. Data analysis

### Summary statistics
```{r}
# percentage of spoiled milk containers at each day of consumer storage
spoilData = ModelData %>% 
    group_by(t_H) %>% 
    summarise(perSpoil = sum(spoil) / (n_sim * n_units)) 

spoilData
(spoilData %>% filter(t_H %in% c(14, 21)) %>% pull(perSpoil) - c(0.286, 0.443)) *100

spoilData %>% 
  ggplot(aes(x = t_H, y = perSpoil*100)) +
  geom_line() +
  #annotate("segment", x = 0, xend = 24, y = 50, yend = 50, linetype = "dashed") +
  #annotate("segment", x = 24, xend = 24, y = 0, yend = 50, linetype = "dashed") +
  labs(y="Percentage of spoiled half-gallon milk (%)",
       x="Consumer storage time (Days)") +
  scale_y_continuous(breaks = seq(0, 80, by = 10)) +
  theme_classic()
ggsave("Figures/Fig5.Baseline.tiff", height = 4, width = 8, units = "in", dpi = "retina")


## spore-former concentration by 14- and 21-day consumer storage
#ModelData %>% 
#  filter(t_H == 14 | t_H == 21) %>% 
#  group_by(t_H) %>% 
#  summarise(mean_conc = mean(predConc_H))
```


### Statistical analysis

Sensitivity analysis (PRCC)
- Following input model parameters are assessed:
*t_F: duration of storage at the facilty by lot (in days)
*T_F: temperature during storage at the facility by lot, same for all units within same lot (in Celsius)
*t_T: duration of transportation from facility to the retail store by lot (in days)
*T_T: temperature during stransportation from facility to the retail store by lot (in Celsius)
*t_S: duration of storage/display at the retail store by lot (in days)
*T_S: temperature during storage/display at the retail store by lot (in Celsius)
*t_T2: duration of transportation from retail store to homes by lot (in days)
*T_T2: temperature during transportation from retail store to homes by lot (in Celsius)
*T_H: temperature during store at homes by lot (in Celsius)
*spore_log10MPN_init_mL: initial spore count in milk (log10 MPN/mL)
*sim_day: duration of storage at homes by lot (in days)

```{r}
# Partial rank correlation coeffcient
sa_predictors = c("t_F","T_F", "t_T", "T_T","t_S", "T_S", "t_T2", "T_T2", "T_H", "log10InitConc")

sa_df = ModelData %>% 
  filter(t_H == 21) %>% 
  select(all_of(sa_predictors), spoil) %>% 
  epi.prcc(., sided.test = 2) %>% 
  mutate(var = sa_predictors)

sa_df %>% ggplot(aes(x = reorder(var, est), y = est)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_x_discrete(labels = c(expression("T"["T2"]), expression("t"["F"]), expression("T"["F"]),
                              expression("t"["T2"]), expression("T"["S"]), expression("t"["S"]),
                              expression("t"["T"]), expression("N"[0]), expression("T"["T"]),
                              expression("T"["H"]))) +
  labs(x="Input parameters",
       y="Partial rank corrrelation coefficient") +
  theme_classic() 

ggsave("Figures/Fig6.PRCC.tiff", height = 4, width = 8, units = "in", dpi = "retina")

# Random forest
train.control = trainControl(method = "repeatedcv",
                             number = 10,
                             repeats = 3)

rf_x = ModelData %>% filter(t_H == 21) %>% select(all_of(sa_predictors)) %>% as.data.frame()
rf_y = ModelData %>% filter(t_H == 21) %>% pull(spoil) %>% as.factor()

cf.fit = train(x = rf_x,
                y = rf_y,
                method = "cforest",
                metric = "Accuracy",
                trControl = train.control)
cf.fit

crf = varImp(cf.fit)
crf_df = tibble(var = rownames(crf$importance), imp = crf$importance$Overall)

crf_df %>% ggplot(aes(x = reorder(var, imp), y = imp)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_x_discrete(labels = c(expression("T"["T2"]), expression("T"["F"]), expression("t"["T2"]),
                              expression("t"["F"]), expression("T"["S"]), expression("t"["S"]),
                              expression("t"["T"]), expression("N"[0]), expression("T"["T"]),
                              expression("T"["H"]))) +
  labs(x="Input parameters",
       y="Variable importance") +
  theme_classic() 

ggsave("Figures/Fig6.Random forest.tiff", height = 4, width = 8, units = "in", dpi = "retina")
```







